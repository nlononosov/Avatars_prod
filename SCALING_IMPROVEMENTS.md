# Улучшения для горизонтального масштабирования

Данный документ описывает реализованные улучшения для поддержки 20-50 одновременных стримеров.

## Реализованные улучшения

### 1. Автоматическое восстановление ботов при старте
- При запуске сервера автоматически вызывается `restoreBotsFromRedis()` для восстановления всех активных ботов
- Боты поднимаются автоматически без ручного вмешательства
- Реализован watchdog для мониторинга и автоматического восстановления упавших ботов

### 2. Проверка Redis при старте
- Добавлена проверка подключения к Redis при старте сервера
- Если `REDIS_REQUIRED=true`, сервер не запустится без Redis (критично для продакшена)
- При недоступности Redis выводится предупреждение (если Redis не обязателен)

### 3. Хранение OAuth state в Redis
- OAuth state для CSRF-защиты теперь хранится в Redis вместо локальной Map
- Поддерживает горизонтальное масштабирование: callback может прийти на любой узел
- Fallback на локальное хранилище если Redis недоступен (не рекомендуется для продакшена)

### 4. Watchdog для ботов
- Автоматический мониторинг здоровья ботов каждые 30 секунд
- Автоматическое восстановление упавших ботов без участия человека
- Проверка синхронизации между локальным состоянием и Redis
- Очистка состояния в Redis при ошибках восстановления

### 5. Улучшенный контроль нагрузки на внешние API
- Адаптивный экспоненциальный backoff при ошибках API (1s, 2s, 4s, 8s, 16s, 32s, 60s макс)
- Трекинг ошибок для каждого стримера отдельно
- Специальная обработка rate limit (429) и серверных ошибок (5xx)
- Мониторинг времени отклика API для раннего обнаружения проблем
- Автоматическое пропускание опросов для стримеров в состоянии backoff

## Настройка

### Для продакшена (обязательный Redis)

```bash
export REDIS_REQUIRED=true
export REDIS_URL=redis://your-redis-host:6379
```

Сервер не запустится если Redis недоступен.

### Для разработки (опциональный Redis)

```bash
export REDIS_REQUIRED=false
# или просто не устанавливайте переменную
```

Сервер запустится даже без Redis, но с предупреждениями.

## Мониторинг

### Метрики ботов
- Количество активных ботов
- Состояние каждого бота (active/inactive)
- Процесс-владелец каждого бота

### Метрики DonationAlerts Polling
- Количество стримеров в backoff
- Время отклика API
- Количество ошибок по типам

## Рекомендации

1. **Для продакшена обязательно установите `REDIS_REQUIRED=true`**
2. Используйте Redis кластер или sentinel для высокой доступности
3. Настройте мониторинг метрик для отслеживания здоровья системы
4. Используйте балансировщик нагрузки для распределения HTTP-запросов
5. Рассмотрите миграцию с SQLite на PostgreSQL/MySQL для асинхронного доступа

## Ограничения

- База данных SQLite остается синхронной (узкое место для 20-50 стримеров)
- SSE подписчики оверлея хранятся локально (но события транслируются через Redis pub/sub)
- Нет автоматического переключения на вебхуки DonationAlerts (только поллинг)

## Следующие шаги

1. Миграция на PostgreSQL/MySQL с пулом соединений
2. Вынос SSE подписчиков в Redis
3. Переключение на вебхуки DonationAlerts при их появлении
4. Расширение метрик и алертов
